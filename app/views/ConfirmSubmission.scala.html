@*
 * Copyright 2021 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import config.AppConfig
@import models.auth.User
@import views.html.templates.formatters.dates.{DisplayDateRange, DisplayDate}
@import views.html.templates.formatters.money.DisplayMoney
@import uk.gov.hmrc.play.views.html.helpers.FormWithCSRF

@this(mainTemplate: MainTemplate,
      formAction: FormWithCSRF,
      displayMoney: DisplayMoney,
      displayDateRange: DisplayDateRange,
      displayDate: DisplayDate)

@(viewModel: ConfirmSubmissionViewModel,
  isAgent: Boolean,
  nIProtocolEnabled: Boolean)(implicit messages: Messages,
                                       appConfig: AppConfig,
                                       user: User[_])

@boxOneSixCorrectRatio = @{
  if(viewModel.returnDetail.box6 > 0) {
    viewModel.returnDetail.box1 / viewModel.returnDetail.box6 < appConfig.maximum9BoxReturnBoxRatio
  } else {
    false
  }
}

@boxFourSevenCorrectRatio = @{
  if(viewModel.returnDetail.box7 > 0) {
    viewModel.returnDetail.box4 / viewModel.returnDetail.box7 < appConfig.maximum9BoxReturnBoxRatio
  } else {
    false
  }
}

@boxDependantMessage(endPath: String, firstBoxIssue: Option[Int] = None, secondBoxIssue: Option[Int] = None) = {
  @(firstBoxIssue, secondBoxIssue) match {
    case (Some(firstBox), Some(secondBox)) => {
      @messages("confirm_submission.warning.singleIssue." + endPath, firstBox, secondBox)
    }
    case (Some(firstBox), None) => {
      @messages("confirm_submission.warning.singleIssue." + endPath, firstBox)
    }
    case _ => {
      @messages("confirm_submission.warning.multipleIssues." + endPath)
    }
  }
}

@warningDisplay(firstBoxIssue: Option[Int] = None, secondBoxIssue: Option[Int] = None) = {
  <div class="grid-row panel panel-border-wide">
    <p>@boxDependantMessage("header", firstBoxIssue, secondBoxIssue)</p>
    <p>@messages("confirm_submission.warning.common.listHeading")</p>
    <ul class="list list-bullet">
      <li>@messages("confirm_submission.warning.common.adjustPrevious")</li>
      <li>@boxDependantMessage("additional", secondBoxIssue)</li>
    </ul>
    <p>
      @messages("confirm_submission.warning.common.checkFigures.part1")
      <a href=@controllers.routes.SubmitFormController.show(viewModel.periodKey)>
        @messages("confirm_submission.warning.common.checkFigures.part2")
      </a>
      @messages("confirm_submission.warning.common.checkFigures.part3")
    </p>
  </div>
}

@validationWarning = {
  @(boxOneSixCorrectRatio, boxFourSevenCorrectRatio) match {
    case (false, false) => {@warningDisplay()}
    case (false, true) => {@warningDisplay(Some(1), Some(6))}
    case (true, false) => {@warningDisplay(Some(4), Some(7))}
    case _ => {}
  }
}

@boxRow(divID: String, formID: String, boxTitle: String, boxDescription: String, boxAmount: BigDecimal) = {
  <div class="grid-row" id=@divID>
    <dt class="column-one-quarter form-hint">@messages(boxTitle)</dt>
    <dd class="column-one-half form-hint">@messages(boxDescription)</dd>
    <dd class="column-one-quarter form-hint text--right">@displayMoney(boxAmount)</dd>
  </div>
}

@declaration(isAgent: Boolean) = {

  <div class="form-group">
    <h3 class="bold-medium">@messages("confirm_submission.declarationHeading")</h3>
  </div>

  @if(isAgent) {
    <p>@messages("confirm_submission.agentDeclaration")</p>
  } else {

    <div class="notice form-group">
      <i class="icon icon-important">
        <span class="visually-hidden">@messages("common.warning")</span>
      </i>

      <strong class="bold-small">@messages("confirm_submission.nonAgentDeclaration")</strong>
    </div>
  }
}

@niProtocolSuffix = @{
  if(nIProtocolEnabled) ".NIProtocol" else ""
}

@mainTemplate(
    messages("confirm_submission.title"),
    appConfig = appConfig,
    user = Some(user)
) {

  @if(!isAgent) {
    <a class="link-back" href="@controllers.routes.SubmitFormController.show(viewModel.periodKey)">@messages("common.back")</a>
  }

  <section>
    <h1 class="heading-xlarge">
      <span class="heading-secondary">@messages("confirm_submission.heading")</span>
        @displayDateRange(viewModel.returnDetail.start, viewModel.returnDetail.end, useShortDayFormat = true)
      <p class="form-hint heading-small">@messages("confirm_submission.returnDueDate", displayDate(viewModel.returnDetail.due))</p>
    </h1>

    @validationWarning

    <h2 class="heading-large">@viewModel.userName</h2>

    <h3 class="bold-small form-group">@messages("confirm_submission.vatDetails")</h3>

    <dl class="form-group divider--bottom">
      <div class="form-group">
        @boxRow(
          "box-one", "box1", "confirm_submission.boxOne",
          s"confirm_submission.boxOneDescription$niProtocolSuffix", viewModel.returnDetail.box1
        )
        @boxRow(
          "box-two", "box2", "confirm_submission.boxTwo",
          s"confirm_submission.boxTwoDescription$niProtocolSuffix", viewModel.returnDetail.box2
        )
      </div>

      <div class="form-group">
        @boxRow(
          "box-three", "box3", "confirm_submission.boxThree",
          s"confirm_submission.boxThreeDescription$niProtocolSuffix", viewModel.returnDetail.box3
        )
        @boxRow(
          "box-four", "box4", "confirm_submission.boxFour",
          s"confirm_submission.boxFourDescription$niProtocolSuffix", viewModel.returnDetail.box4
        )
      </div>

      <div class="form-group">
        <div class="grid-row" id="box-five">
          <dt class="column-one-quarter">
            <strong class="bold-small">@messages("confirm_submission.boxFive")</strong>
          </dt>
          <dd class="column-one-half">
            <strong class="bold-small">@messages(s"confirm_submission.boxFiveDescription$niProtocolSuffix")</strong>
          </dd>
          <dd class="column-one-quarter text--right">
            <strong class="bold-small">@displayMoney(viewModel.returnDetail.box5)</strong>
          </dd>
        </div>
      </div>

    </dl>

    <h3 class="bold-small form-group">@messages("confirm_submission.additionalInfo")</h3>

    <dl class="form-group divider--bottom">
      <div class="form-group">
        @if(viewModel.returnDetail.flatRateScheme){
          @boxRow(
            "box-six", "box6", "confirm_submission.boxSix",
            "confirm_submission.boxSixFlatRate", viewModel.returnDetail.box6
          )
        } else {
          @boxRow(
            "box-six", "box6", "confirm_submission.boxSix",
            "confirm_submission.boxSixNoFlatRate", viewModel.returnDetail.box6
          )
        }
        @boxRow(
          "box-seven", "box7", "confirm_submission.boxSeven",
          s"confirm_submission.boxSevenDescription$niProtocolSuffix", viewModel.returnDetail.box7
        )
        @boxRow(
          "box-eight", "box8", "confirm_submission.boxEight",
          s"confirm_submission.boxEightDescription$niProtocolSuffix", viewModel.returnDetail.box8
        )
        @boxRow(
          "box-nine", "box9", "confirm_submission.boxNine",
          s"confirm_submission.boxNineDescription$niProtocolSuffix", viewModel.returnDetail.box9
        )
      </div>
    </dl>

    <section class="form-group divider--bottom">
      <div class="form-group">
        <h3 class="bold-large">@messages("confirm_submission.returnTotal")@displayMoney(viewModel.returnDetail.box5)</h3>
        <p>@messages("confirm_submission.returnDueDate", displayDate(viewModel.returnDetail.due))</p>
        <a
          href=@controllers.routes.SubmitFormController.show(viewModel.periodKey)>
          @messages("confirm_submission.changeDetail")
        </a>
      </div>
    </section>

    @declaration(isAgent: Boolean)

    @formAction(action = controllers.routes.ConfirmSubmissionController.submit(viewModel.periodKey)) {
      <button
        class="button"
        type ="submit">
        @messages("confirm_submission.acceptAndSend")
      </button>
    }

  </section>

}
